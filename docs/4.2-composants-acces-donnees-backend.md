# 4.2. Composants d'accès aux données (Back-end)

## Introduction

Dans Cinetech, l'accès aux données côté back-end repose sur l'utilisation du framework Laravel et de son ORM Eloquent. L'objectif est de garantir un code simple, sécurisé, et conforme aux bonnes pratiques DWWM, tout en facilitant la maintenance et la présentation orale.

---

## 1. Modèles Eloquent (ORM)

Les modèles Eloquent représentent les tables de la base de données et permettent d'effectuer toutes les opérations CRUD (Create, Read, Update, Delete) de façon sécurisée.

**Exemple : Modèle `Comment`**
```php
class Comment extends Model
{
    protected $fillable = ['user_id', 'tmdb_id', 'type', 'content'];

    // Relation : un commentaire appartient à un utilisateur
    public function user() {
        return $this->belongsTo(User::class);
    }

    // Scope personnalisé pour filtrer par film/série
    public function scopeForMedia($query, int $tmdbId, string $type) {
        return $query->where('tmdb_id', $tmdbId)
                     ->where('type', $type)
                     ->with(['user:id,nickname']);
    }
}
```
- **Avantages :** Génère automatiquement les requêtes SQL, protège contre les injections, gère les relations (ex : un commentaire appartient à un utilisateur).

---

## 2. Contrôleurs d'accès aux données

Les contrôleurs orchestrent la logique d'accès aux données : ils reçoivent les requêtes du front-end, valident les données, utilisent les modèles pour accéder à la base, et renvoient la réponse (JSON ou vue).

**Exemple : `CommentController`**
```php
public function index(Request $request)
{
    $comments = Comment::forMedia($request->tmdb_id, $request->type)
        ->latest()
        ->paginate(3);

    return response()->json([
        'comments' => $comments->items(),
        'current_page' => $comments->currentPage(),
        'last_page' => $comments->lastPage(),
        'total' => $comments->total(),
    ]);
}

public function store(Request $request)
{
    $validated = $request->validate([
        'tmdb_id' => 'required|integer',
        'type' => 'required|in:movie,tv',
        'content' => 'required|string|max:1000'
    ]);

    $comment = Comment::create([
        'user_id' => auth()->id(),
        'tmdb_id' => $validated['tmdb_id'],
        'type' => $validated['type'],
        'content' => $validated['content']
    ]);

    return response()->json([
        'comment' => $comment,
        'message' => 'Commentaire ajouté avec succès',
        'status' => 'success'
    ], 201);
}
```
- **Validation** : Toutes les données sont validées côté serveur.
- **Sécurité** : Seuls les utilisateurs authentifiés peuvent créer/modifier/supprimer.

---

## 3. Migrations : structure des tables

Les migrations sont des scripts PHP qui créent ou modifient la structure des tables. Elles assurent la reproductibilité et la traçabilité de la base.

**Exemple : Table `comments`**
```php
Schema::create('comments', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->onDelete('cascade');
    $table->integer('tmdb_id');
    $table->string('type');
    $table->text('content');
    $table->timestamps();
});
```
- **Avantage :** On peut versionner et faire évoluer la structure facilement.

---

## 4. Accès aux données externes (API TMDB)

Pour enrichir les données, le back-end interroge l'API TMDB via la façade `Http` de Laravel.

**Exemple :**
```php
$response = Http::get("https://api.themoviedb.org/3/movie/{$tmdb_id}", [
    'api_key' => config('services.tmdb.api_key'),
    'language' => 'fr-FR'
]);
$title = $response->json('title') ?? 'Film inconnu';
```
- **Utilité :** Permet d'afficher dynamiquement les titres, images, etc.

---

## 5. Sécurité et gestion des droits d'accès

L'accès aux données sensibles est protégé par :
- **Policies** : seules les personnes autorisées peuvent modifier/supprimer.
- **Exemple :**
```php
// app/Policies/CommentPolicy.php
public function delete(User $user, Comment $comment)
{
    return $user->isAdmin() || $user->id === $comment->user_id;
}
```
- **Middleware** : vérifie l'authentification et le rôle (admin/user).
- **CSRF** : protection automatique sur tous les formulaires.

---

## 6. Routes d'accès aux données

Les routes définissent les points d'entrée pour accéder aux données.

**Exemple :**
```php
// routes/web.php
Route::prefix('comments')->group(function () {
    Route::get('/', [CommentController::class, 'index'])->name('comments.index');
    Route::post('/', [CommentController::class, 'store'])->name('comments.store');
    Route::put('/{comment}', [CommentController::class, 'update'])->name('comments.update');
    Route::delete('/{comment}', [CommentController::class, 'destroy'])->name('comments.destroy');
});
```
- **API REST** : Les routes sont accessibles en AJAX/JS pour l'affichage dynamique.

---

## 7. Administration et modération

L'admin accède à une interface dédiée pour modérer les commentaires.

**Exemple :**
```php
// app/Http/Controllers/AdminController.php
public function comments()
{
    $comments = \App\Models\Comment::with('user')->latest()->paginate(15);
    return view('admin.comments', compact('comments'));
}
```
- **Seul l'admin** peut supprimer n'importe quel commentaire (policy).

---

## 8. Résumé schématique

- **Modèles** : accès direct aux tables (ORM)
- **Contrôleurs** : orchestrent la logique d'accès et de validation
- **Scopes** : facilitent les requêtes filtrées
- **Migrations** : structurent la base
- **API externes** : enrichissent les données
- **Sécurité** : validation, CSRF, rôles, policies

---

## Conclusion

L'ensemble de ces composants garantit un accès aux données simple, sécurisé, et conforme aux attentes du diplôme DWWM.  
**À l'oral, insiste sur la clarté, la séparation des responsabilités, la sécurité et la simplicité du code.**

---

_N'hésite pas à adapter ce markdown ou à demander des exemples supplémentaires pour d'autres entités (users, favoris, etc.) si besoin._ 